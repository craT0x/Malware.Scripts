#!/usr/bin

import argparse
import sys

__author__ = "craT0x"
__copyright__ = "@justmlwhunting"
__version__ = 20181025


VERSION1_OFFSET = 7
VERSION2_OFFSET = 25

VERSION1_SIZE = 14500
VERSION2_SIZE = 43400


def extract_config(filename):

    result = None
    config = ""
    with open(filename, "rb") as f:
        buff = f.read()

    buff_len = len(buff)
    i = 0

    while i < buff_len and config=="":

        # Kraken v1.x
        if buff[i: i + VERSION1_OFFSET] == "\x64\x00\x61\x00\x74\x00\x61":
            print "[+] Kraken v1.x"
            config = buff[i: i + VERSION1_OFFSET + VERSION1_SIZE]

        # Kraken v2.x
        if buff[i: i + VERSION2_OFFSET] == "\x63\x00\x6F\x00\x6E\x00\x66\x00\x69\x00\x67\x00\x75\x00\x72\x00\x61\x00\x74\x00\x69\x00\x6F\x00\x6E":
            print "[+] Kraken v2.x"
            config = buff[i: i + VERSION2_OFFSET + VERSION2_SIZE]
        i += 1

    config_filename = filename + "_config.bin"

    with open(config_filename, "w") as f:
        f.write(config)

    return config_filename


if __name__ == "__main__":

    arg_parser = argparse.ArgumentParser(
        description='[+] Kraken Ransomware config extractor')
    arg_parser.add_argument('-f', '--filename', type=str, help='PE file to parse')
    args = arg_parser.parse_args()
    filename = args.filename

    if not filename:
        arg_parser.print_help()
        sys.exit(1)

    print "[+] Config saved: {0}".format(extract_config(filename=filename))
