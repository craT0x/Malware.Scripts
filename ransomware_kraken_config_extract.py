#!/usr/bin

import argparse
import sys
import pefile
import json

__author__ = "craT0x"
__copyright__ = "@justmlwhunting"
__version__ = 20181025


def extract_config(file):

    result = None
    config = ""
    f = open(file, "rb")

    i=0
    while i < len(f.read()):

        # Kraken v1.x
        byte = f.seek(i)
        check = f.read(7)        
        if check == "\x64\x00\x61\x00\x74\x00\x61":
            print "[+] Kraken v1.x"
            config = check + f.read(14500)

        # Kraken v2.x
        byte = f.seek(i)
        check = f.read(25)
        if check == "\x63\x00\x6F\x00\x6E\x00\x66\x00\x69\x00\x67\x00\x75\x00\x72\x00\x61\x00\x74\x00\x69\x00\x6F\x00\x6E":
            print "[+] Kraken v2.x"
            config = check + f.read(43400)
        i+=1
     
    config_file = file + "_config.json"
    file = open(config_file,"w")
    file.write(config)
    file.close()

    return config_file


if __name__ == "__main__":

    arg_parser = argparse.ArgumentParser(
        description='[+] Kraken Ransomware config extractor')
    arg_parser.add_argument('-f', '--file', type=str, help='PE file to parse')
    args = arg_parser.parse_args()
    file = args.file

    if not file:
        arg_parser.print_help()
        sys.exit(1)

    print "[+] Config saved: {0}".format(extract_config(file=file))
